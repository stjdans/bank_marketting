{% extends "base.html" %}
{% block title %}대출 심사 - 심심한 AI 마케팅{% endblock %}
{% block content %}
<div class="page-container loan-page">
  <div class="content-wrapper">
    <!-- Left Card: Customer Details View -->
    <div class="card left-panel">
      <div class="card-header">
        <h2><i class="fa-solid fa-user-check icon-accent"></i> 고객 세부 정보 조회</h2>
        <button class="btn btn-primary" id="check"><i class="fa-solid fa-brain"></i> AI 심사 실행</button>
      </div>
      <div class="card-body">
        <form id="form" onsubmit="return false;">
            <div class="search-section">
                <div class="search-row">
                    <div class="search-item">
                        <label for="customer-name">고객 성함</label>
                        {% if user %}
                            <input type="text" id="customer-name" name="customer_name" class="form-control" value="{{ user[0] }}">
                        {% else %}
                            <input type="text" id="customer-name" name="customer_name" class="form-control" placeholder="홍길동">
                        {% endif %}
                    </div>
                    <div class="search-item">
                        <label for="birth-date">연락처</label>
                        {% if user %}
                            <input type="text" id="birth-date" name="birth_date" class="form-control" value="{{ user[1] }}">
                        {% else %}
                            <input type="text" id="birth-date" name="birth_date" class="form-control" placeholder="010-123-4567">
                        {% endif %}
                    </div>
                    <div class="search-button">
                        <button type="button" class="btn btn-search-large" onclick="searchCustomer()">
                            <i class="fa-solid fa-magnifying-glass"></i> 조회
                        </button>
                    </div>
                </div>
            </div>

            {% if user %}
                <div class="info-grid">
                    <div class="info-item"><label>나이</label><span>{{user[2]}}</span></div>
                    <div class="info-item"><label>직업</label><span>{{user[3]}}</span></div>
                    <div class="info-item"><label>결혼상태</label><span>{{user[4]}}</span></div>
                    <div class="info-item"><label>교육수준</label><span>{{user[5]}}</span></div>
                    <div class="info-item"><label>신용 상태</label><span>{{user[6]}}</span></div>
                    <div class="info-item"><label>계좌 잔고(달러)</label><span>{{user[7]}}</span></div>
                    <div class="info-item"><label>주택 대출</label><span>{{user[8]}}</span></div>
                    <div class="info-item"><label>개인 대출</label><span>{{user[9]}}</span></div>
                    <div class="info-item"><label>최근 통화(초)</label><span>{{user[14]}}</span></div>
                    <div class="info-item"><label>이전 캠페인</label><span>{{user[17]}}</span></div>
                </div>
            {% else %}
    
            {% endif %}
            
        </form>
      </div>
    </div>

    <!-- Right Card: Assessment Result -->
    <div class="card right-panel">
      <div class="card-header">
        <h2><i class="fa-solid fa-gavel icon-accent"></i> 심사결과</h2>
      </div>
      <div class="card-body">
        <div id="assessment-result" class="assessment-result">
          <div class="result-placeholder">
            <i class="fa-solid fa-search"></i>
            <p>고객 정보를 입력하고 조회 버튼을 눌러주세요</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Assessment Result Modal -->
<div id="result-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" id="modal-close-btn">&times;</button>
        <div id="modal-body">
            <!-- Content will be injected by JavaScript -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary"><i class="fa-solid fa-save"></i> 심사결과 저장</button>
        </div>
    </div>
</div>


<script>
    // Initial sample data
    const tbody = document.querySelector('#listTable tbody');
    const bar = document.getElementById('bar');
    const progressText = document.getElementById('progressText');
    const checkBtn = document.getElementById('check');
    const modal = document.getElementById('result-modal');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    // 고객 조회 함수
    function searchCustomer() {
        const customerName = document.getElementById('customer-name').value;
        const phone = document.getElementById('birth-date').value;
        
        if (!customerName || !phone) {
            alert('고객 성함과 생년월일을 모두 입력해주세요.');
            return;
        }

        console.log('searchCustomer....');
        window.location.href = '/loan?name=' + customerName + '&phone=' + phone;
    }

    function predict_loan() {
        const customerName = document.getElementById('customer-name').value;
        const phone = document.getElementById('birth-date').value;
        
        if (!customerName || !phone) {
            alert('고객 성함과 연락처를 모두 입력해주세요.');
            return;
        }

        console.log('predict_loan....');
        
        // 시뮬레이션: 실제 DB 조회 대신 랜덤 결과 생성
        const resultContainer = document.getElementById('assessment-result');
        
        // 로딩 상태
        resultContainer.innerHTML = `
            <div class="result-loading">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <p>고객 정보를 조회하고 있습니다...</p>
            </div>
        `;

        // FormData 객체 생성
        const formData = new FormData();
        formData.append("name", customerName);
        formData.append("phone", phone);

        fetch("/eval_loan", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('서버 응답 : ', data)
            prob = data['result']
            console.log(prob)
            show_eval_loan(prob, customerName)
        }).catch(error => {
            console.error(error)
        });
    }

    function show_eval_loan(prob, customerName) {
        const randomResult = prob
        let resultHtml = '';
        const resultContainer = document.getElementById('assessment-result');

        if (randomResult > 0.5) {
            // 대출 승인
            resultHtml = `
                <div class="result-card result-success">
                    <div class="result-icon">
                        <i class="fa-solid fa-check-circle"></i>
                    </div>
                    <div class="result-content">
                        <h3 class="result-title">축하합니다!</h3>
                        <p class="result-description">${customerName} 고객님은 대출 가능합니다</p>
                        <div class="result-status success">YES</div>
                    </div>
                </div>
            `;
        } else {
            // 대출 거절
            resultHtml = `
                <div class="result-card result-failure">
                    <div class="result-icon">
                        <i class="fa-solid fa-times-circle"></i>
                    </div>
                    <div class="result-content">
                        <h3 class="result-title">죄송합니다!</h3>
                        <p class="result-description">${customerName} 고객님은 대출이 불가능합니다</p>
                        <div class="result-status failure">NO</div>
                    </div>
                </div>
            `;
        }
        
        resultContainer.innerHTML = resultHtml;
    }

    // Event Listeners
    checkBtn.addEventListener('click', () => {
        predict_loan();
    });

    modalCloseBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
</script>
{% endblock %}

